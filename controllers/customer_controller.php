<?php/*----------------------------------------------------- Insert customer (1) -------------------------------------------- * Tester si le formulaire d'insertion existe avec le bouton valider de la page gestion clients. * Vérifier si toutes les données envoyées en post existent. * Verifier si variables ne sont pas de caractères blancs (vides). *  Récupère toutes les variables externes et les filtrer.* --------------------------------------------------------------------------------------------------------------------*/if (!empty($_POST) && isset($_POST['btnCustomerInsert']) && isset($_POST['sexe']) && isset($_POST['name'])    && isset($_POST['firstname']) && isset($_POST['email']) && isset($_POST['phone']) && isset($_POST['society'])    && isset($_POST['way']) && isset($_POST['postalcode']) && isset($_POST['city'])) {    if (ctype_space($_POST['sexe']) or ctype_space($_POST['name']) or ctype_space($_POST['firstname'])        or ctype_space($_POST['email']) or ctype_space($_POST['phone']) or ctype_space($_POST['society'])        or ctype_space($_POST['way']) or ctype_space($_POST['postalcode']) or ctype_space($_POST['city'])) {        echo '<i style="color:#850008;font-size:30px;font-family:calibri ;">                Veuillez verifier la saisie de données !</i> ';    } else {        $sexe = ucfirst(trim(filter_input(INPUT_POST, 'sexe', FILTER_SANITIZE_STRING)));        $name = strtoupper(trim(filter_input(INPUT_POST, 'name', FILTER_SANITIZE_STRING)));        $firstname = ucfirst(trim(filter_input(INPUT_POST, 'firstname', FILTER_SANITIZE_STRING)));        $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);        $phone = filter_input(INPUT_POST, 'phone', FILTER_SANITIZE_NUMBER_INT);        $society = strtoupper(trim(filter_input(INPUT_POST, 'society', FILTER_SANITIZE_STRING)));        $way = ucwords(trim(filter_input(INPUT_POST, 'way', FILTER_SANITIZE_STRING)));        $postalcode = filter_input(INPUT_POST, 'postalcode', FILTER_SANITIZE_NUMBER_INT);        $city = strtoupper(trim(filter_input(INPUT_POST, 'city', FILTER_SANITIZE_STRING)));        // Instancier la class Address        $address = new Address();        $address->setWay($way);        $address->setPostalcode($postalcode);        $address->setCity($city);        // Instancier la classe Customers        $customer = new Customers();        $customer->setSexe($sexe);        $customer->setName($name);        $customer->setFirstname($firstname);        $customer->setEmail($email);        $customer->setPhone($phone);        $customer->setSociety($society);        // Récuperer le plus grand  customer id        $requete = $db->query('SELECT MAX(idC) FROM customers');        $donnee = $requete->fetchColumn();        //Initilisation du customernumber        $customernumber = substr($postalcode, 0, 2) . ($donnee + 1);        // Verification de l'adresse mail saisie        if ($customer->isCustomerExiste($customer->getEmail()) == 0) {            // Condition où l'adresse existe et le client aussi ou le client tout seul            if ($address->isAddressExiste($address->getWay(), $address->getPostalcode(), $address->getCity())) {                // Récuperartion de l'id de l'adresse existante et le stocker dans une variable                $var = $address->recupIdAdress($way, $postalcode, $city);                //Insertion du nouveau client                $customer->setCustomernumber($customernumber);                $customer->setAddressId($var);                $customer->addCustomer();                // Message de confirmation d'insertion                echo '<i style="color:#1b6d85;font-size:30px;font-family:calibri ;">Insertion faite avec succès</i> ';            } else {                //Insertion de nouvelle adresse                $address->addAddress();                // Récuperation l'id de la l'adresse inserrée                $lastInsertId = $db->lastInsertId();                //Insertion du nouveau client                $customer->setCustomernumber($customernumber);                $customer->setAddressId($lastInsertId);                $customer->addCustomer();                // Message d'insertion                echo '<i style="color:#1b6d85;font-size:30px;font-family:calibri ;">Insertion faite avec succès</i> ';            }        } else {            echo '<i style="color:#850008;font-size:30px;font-family:calibri ;">                Client existe déjà Veillez le mettre à jour</i> ';        }        // Destruction de la variable session        unset($_SESSION['idC'], $_SESSION['sexe'], $_SESSION['name'], $_SESSION['firstname'], $_SESSION['email'],            $_SESSION['phone'], $_SESSION['society'], $_SESSION['way'], $_SESSION['postalcode'], $_SESSION['city']);    }/*------------------------------------- End insert customer (1) -------------------------------------------------*/} /*----------------------------------------------- Update customer (2) ------------------------------------------------ * Tester si le formulaire d'update existe avec le bouton valider de la page gestion clients. * Vérifier si toutes les données envoyées en post existent. * Verifier si variables ne sont pas de caractères blancs (vides). *  Récupère toutes les variables externes et les filtrer. *--------------------------------------------------------------------------------------------------------------------*/elseif (!empty($_POST) && isset($_POST['btnCustomerUpdate']) && isset($_POST['sexe']) && isset($_POST['name'])    && isset($_POST['firstname']) && isset($_POST['email']) && isset($_POST['phone']) && isset($_POST['society'])    && isset($_POST['way']) && isset($_POST['postalcode']) && isset($_POST['city'])) {    if (isset($_SESSION['idC'])) {        if (ctype_space($_POST['sexe']) or ctype_space($_POST['name']) or ctype_space($_POST['firstname'])            or ctype_space($_POST['email']) or ctype_space($_POST['phone']) or ctype_space($_POST['society'])            or ctype_space($_POST['way']) or ctype_space($_POST['postalcode']) or ctype_space($_POST['city'])) {            echo '<i style="color:#850008;font-size:30px;font-family:calibri ;">                Veuillez verifier la saisie de données !</i> ';        } else {            $idC = filter_var($_SESSION['idC'], FILTER_SANITIZE_NUMBER_INT);            $sexe = ucfirst(trim(filter_input(INPUT_POST, 'sexe', FILTER_SANITIZE_STRING)));            $name = strtoupper(trim(filter_input(INPUT_POST, 'name', FILTER_SANITIZE_STRING)));            $firstname = ucfirst(trim(filter_input(INPUT_POST, 'firstname', FILTER_SANITIZE_STRING)));            $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);            $phone = filter_input(INPUT_POST, 'phone', FILTER_SANITIZE_NUMBER_INT);            $society = strtoupper(trim(filter_input(INPUT_POST, 'society', FILTER_SANITIZE_STRING)));            $way = ucwords(trim(filter_input(INPUT_POST, 'way', FILTER_SANITIZE_STRING)));            $postalcode = filter_input(INPUT_POST, 'postalcode', FILTER_SANITIZE_NUMBER_INT);            $city = strtoupper(trim(filter_input(INPUT_POST, 'city', FILTER_SANITIZE_STRING)));            // Instanciation classe adresse            $address = new Address();            $address->setWay($way);            $address->setPostalcode($postalcode);            $address->setCity($city);            // Récuperartion de l'id de l'adresse existante et le stocker dans une variable            $requete = $address->recupIdAdress($way, $postalcode, $city);            // Instanciation classe customers            $customer = new Customers();            $customer->setIdC($idC);            $customer->setSexe($sexe);            $customer->setName($name);            $customer->setFirstname($firstname);            $customer->setEmail($email);            $customer->setPhone($phone);            $customer->setSociety($society);            // Récupération les anciennes données du client            $var = $customer->recupCustomerdetails($idC);            $donnee = $var->fetch();            // Vérification si la nouvelle adresse mail existe et quelle n'est pa sassociée au client réference            if ($email !== $donnee['email'] and $customer->isCustomerExiste($customer->getEmail())) {                echo '<i style="color:#b92c28;font-size:30px;font-family:calibri ;">                    Cette adresse mail existe déja veuillez verifier votre saisie</i> ';            } else {                $var = $customer->countCustomerAdsressId($donnee['address_id']);                if ($var > 1) {                    /*------- Cas ou l'ancienne adresse est attachée à plus d'un client -------*/                    //Insertion de nouvelle adresse                    $address->addAddress();                    // Recuperation de l'id de la nouvelle adresse inserrée                    $lastInsertId = $db->lastInsertId();                    // Modification données client                    $customer->setAddressId($lastInsertId);                    $customer->updateCustomer();                } elseif ($requete != $donnee['address_id'] and                    $address->isAddressExiste($address->getWay(), $address->getPostalcode(), $address->getCity())) {                    /*-------------- Cas ou la nouvelle adresse existe ------------*/                    // Modification données client                    $customer->setAddressId($requete);                    $customer->updateCustomer();                    // Suppression de l'ancienne adresse                    $address->setIdA($donnee['address_id']);                    $address->deleteAddress();                } elseif ($address->isAddressExiste($address->getWay(), $address->getPostalcode(), $address->getCity()) == 0) {                    /*-------------- Cas ou la nouvelle adresse n'existe pas ------------*/                    // Modification données client uniquement                    $customer->setAddressId($donnee['address_id']);                    $customer->updateCustomer();                    $address->setIdA($donnee['address_id']);                    $address->updateAddress();                } elseif ($way = $_SESSION['way'] and $postalcode = $_SESSION['postalcode'] and $city = $_SESSION['city']) {                    /*-------------- Cas ou l'aadresse n'est pas modifiée ------------*/                    $customer->setAddressId($donnee['address_id']);                    $customer->updateCustomer();                }            }        }        // Destruction de la variable session        unset($_SESSION['idC'], $_SESSION['sexe'], $_SESSION['name'], $_SESSION['firstname'], $_SESSION['email'],            $_SESSION['phone'], $_SESSION['society'], $_SESSION['way'], $_SESSION['postalcode'], $_SESSION['city']);    } else {        echo '<i style="color:#850008;font-size:30px;font-family:calibri ;">                Veuillez selectionner un client avant !</i> ';    }/*-------------------------------------------- End Update customer (2) ------------------------------------------*/}/*----------------------------------------------- Delete customer (3) -------------------------------------------------* Tester si le formulaire d'delete existe avec le bouton valider de la page gestion clients.* Vérifier si toutes les données envoyées en post existent.* Verifier si variables ne sont pas de caractères blancs (vides).* Récupère toutes les variables externes et les filtrer.*---------------------------------------------------------------------------------------------------------------------*/elseif (!empty($_POST) && isset($_POST['btnCustomerDelete']) && isset($_POST['sexe']) && isset($_POST['name'])    && isset($_POST['firstname']) && isset($_POST['email']) && isset($_POST['phone']) && isset($_POST['society'])    && isset($_POST['way']) && isset($_POST['postalcode']) && isset($_POST['city'])) {    if (isset($_SESSION['idC'])) {        if (ctype_space($_POST['sexe']) or ctype_space($_POST['name']) or ctype_space($_POST['firstname'])            or ctype_space($_POST['email']) or ctype_space($_POST['phone']) or ctype_space($_POST['society'])            or ctype_space($_POST['way']) or ctype_space($_POST['postalcode']) or ctype_space($_POST['city'])) {            echo '<i style="color:#850008;font-size:30px;font-family:calibri ;">                Veuillez verifier les données à supprimer !</i> ';        } else {            // Filtrer l'id en variable de session            $idC = filter_var($_SESSION['idC'], FILTER_SANITIZE_NUMBER_INT);            // Instanciation classe customers            $customer = new Customers();            $customer->setIdC($idC);            // Récupération les anciennes données du client            $var = $customer->recupCustomerdetails($idC);            $donnee = $var->fetch();            // Vérification s'il ya un devis lié au client            $quotation = new Quotation();            $req = $quotation->countQuotationCustomerId($idC);            if ($req > 0) {                echo '<i style="color:#b92c28;font-size:30px;font-family:calibri ;">                    Pas possible de supprimer ce client , liaison de devis</i> ';            } else {                // Vérification si l'ancienne adresse postale est associée à plus d'un client                $requete = intval($customer->countCustomerAdsressId($donnee['address_id']));                if ($requete > 1) {                    // Suppression du client uniquement                    $customer->deleteCustomer();                } elseif ($requete <= 1) {                    // Récupération de données du client                    $var = $customer->recupCustomerdetails($idC);                    $donnee = $var->fetch();                    // Supression de client et son adresse                    $customer->deleteCustomer();                    $address = new Address();                    $address->setIdA($donnee['address_id']);                    $address->deleteAddress();                }            }        }        // Destruction de la variable session        unset($_SESSION['idC'], $_SESSION['sexe'], $_SESSION['name'], $_SESSION['firstname'], $_SESSION['email'],            $_SESSION['phone'], $_SESSION['society'], $_SESSION['way'], $_SESSION['postalcode'], $_SESSION['city']);    } else {        echo '<i style="color:#850008;font-size:30px;font-family:calibri ;">                Veuillez selectionner un client avant !</i> ';    }/*---------------------------------------End Delete customer (3) ------------------------------------------------*/} /*------------------------------------Déclaration of session variables (4) ------------------------------------------- * Tester si le formulaire de declaration existe avec le bouton selectionner de la page gestion clients. * Vérifier si toutes les données envoyées en get existent. * Verifier si variables ne sont pas de caractères blancs (vides). * Récupère toutes les variables externes et les filtrer. *--------------------------------------------------------------------------------------------------------------------*/ elseif (!empty($_GET) && isset($_GET['idCustomer']) && isset($_GET['sexe']) && isset($_GET['name'])    && isset($_GET['firstname']) && isset($_GET['email']) && isset($_GET['phone']) && isset($_GET['society'])    && isset($_GET['way'])  && isset($_GET['postalcode']) && isset($_GET['city'])) {    $_SESSION['idC'] = filter_input(INPUT_GET, 'idCustomer', FILTER_SANITIZE_NUMBER_INT);    $_SESSION['sexe'] = filter_input(INPUT_GET, 'sexe', FILTER_SANITIZE_STRING);    $_SESSION['name'] = filter_input(INPUT_GET, 'name', FILTER_SANITIZE_STRING);    $_SESSION['firstname'] = filter_input(INPUT_GET, 'firstname', FILTER_SANITIZE_STRING);    $_SESSION['email'] = filter_input(INPUT_GET, 'email', FILTER_SANITIZE_STRING);    $_SESSION['phone'] = filter_input(INPUT_GET, 'phone', FILTER_SANITIZE_NUMBER_INT);    $_SESSION['society'] = filter_input(INPUT_GET, 'society', FILTER_SANITIZE_STRING);    $_SESSION['way'] = filter_input(INPUT_GET, 'way', FILTER_SANITIZE_STRING);    $_SESSION['postalcode'] = filter_input(INPUT_GET, 'postalcode', FILTER_SANITIZE_NUMBER_INT);    $_SESSION['city'] = filter_input(INPUT_GET, 'city', FILTER_SANITIZE_STRING);    // Retour à la page précedente    header("Location: $_SERVER[HTTP_REFERER]");}/*------------------------------------ End déclaration of session variables (4) -------------------------------------*/